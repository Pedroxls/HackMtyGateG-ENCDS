# üîê Flujo de Autenticaci√≥n - GateApp Mobile

## üìä Diagrama del Flujo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    1. APP INICIA                            ‚îÇ
‚îÇ                    app/_layout.jsx                          ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  useEffect(() => {                                          ‚îÇ
‚îÇ    initialize(); // Inicializa authStore                    ‚îÇ
‚îÇ  })                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              2. INICIALIZACI√ìN AUTH                         ‚îÇ
‚îÇ              src/store/authStore.js                         ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  initialize: async () => {                                  ‚îÇ
‚îÇ    const { session } = await supabase.auth.getSession();   ‚îÇ
‚îÇ    set({ user: session?.user, loading: false });           ‚îÇ
‚îÇ  }                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                3. PUNTO DE ENTRADA                          ‚îÇ
‚îÇ                app/index.jsx                                ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  useEffect(() => {                                          ‚îÇ
‚îÇ    if (!loading) {                                          ‚îÇ
‚îÇ      if (user) {                                            ‚îÇ
‚îÇ        router.replace('/dashboard'); ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ      } else {                               ‚îÇ               ‚îÇ
‚îÇ        router.replace('/login'); ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ               ‚îÇ
‚îÇ      }                               ‚îÇ      ‚îÇ               ‚îÇ
‚îÇ    }                                 ‚îÇ      ‚îÇ               ‚îÇ
‚îÇ  }, [user, loading])                 ‚îÇ      ‚îÇ               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                       ‚îÇ      ‚îÇ
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
                     ‚ñº                        ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ         4A. SIN SESI√ìN                  ‚îÇ  ‚îÇ
‚îÇ         app/login.jsx                   ‚îÇ  ‚îÇ
‚îÇ         LoginScreen.jsx                 ‚îÇ  ‚îÇ
‚îÇ                                         ‚îÇ  ‚îÇ
‚îÇ  Usuario ingresa:                       ‚îÇ  ‚îÇ
‚îÇ  - Email                                ‚îÇ  ‚îÇ
‚îÇ  - Password                             ‚îÇ  ‚îÇ
‚îÇ                                         ‚îÇ  ‚îÇ
‚îÇ  Click "Iniciar Sesi√≥n"                 ‚îÇ  ‚îÇ
‚îÇ    ‚Üì                                    ‚îÇ  ‚îÇ
‚îÇ  handleLogin() {                        ‚îÇ  ‚îÇ
‚îÇ    const result = await signIn(...);    ‚îÇ  ‚îÇ
‚îÇ    if (result.success) {                ‚îÇ  ‚îÇ
‚îÇ      router.replace('/dashboard'); ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îò
‚îÇ    }                                    ‚îÇ
‚îÇ  }                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              4B. CON SESI√ìN                                 ‚îÇ
‚îÇ              app/dashboard.jsx                              ‚îÇ
‚îÇ              DashboardScreen.jsx                            ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Usuario ve:                                                ‚îÇ
‚îÇ  - Estad√≠sticas                                             ‚îÇ
‚îÇ  - Acciones r√°pidas                                         ‚îÇ
‚îÇ  - Actividad reciente                                       ‚îÇ
‚îÇ  - Bot√≥n "Salir"                                            ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Click en "Salir" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ
‚îÇ                              ‚ñº                              ‚îÇ
‚îÇ  handleLogout() {                                           ‚îÇ
‚îÇ    Alert.alert("¬øCerrar sesi√≥n?")                           ‚îÇ
‚îÇ    onPress: async () => {                                   ‚îÇ
‚îÇ      await signOut();                                       ‚îÇ
‚îÇ      router.replace('/login'); ‚óÑ‚îÄ‚îÄ‚îÄ ¬°ARREGLADO!            ‚îÇ
‚îÇ    }                                                        ‚îÇ
‚îÇ  }                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ Flujo Detallado Paso a Paso

### 1Ô∏è‚É£ Inicio de la App

**Archivo**: `app/_layout.jsx`

```jsx
export default function RootLayout() {
  const { initialize } = useAuthStore();

  useEffect(() => {
    initialize(); // ‚Üê Verifica si hay sesi√≥n guardada
  }, []);

  return <Slot />;
}
```

**¬øQu√© hace?**
- Llama a `initialize()` del authStore
- Verifica si hay una sesi√≥n en AsyncStorage
- Actualiza el estado `user` y `loading`

---

### 2Ô∏è‚É£ Verificaci√≥n de Sesi√≥n

**Archivo**: `src/store/authStore.js`

```jsx
initialize: async () => {
  set({ loading: true });

  const { data: { session } } = await supabase.auth.getSession();

  set({
    session,
    user: session?.user ?? null,
    loading: false
  });
}
```

**Posibles resultados:**
- ‚úÖ **Hay sesi√≥n** ‚Üí `user = { id, email, ... }`
- ‚ùå **No hay sesi√≥n** ‚Üí `user = null`

---

### 3Ô∏è‚É£ Redirecci√≥n Autom√°tica

**Archivo**: `app/index.jsx`

```jsx
export default function Index() {
  const { user, loading } = useAuthStore();

  useEffect(() => {
    if (!loading) {
      if (user) {
        router.replace('/dashboard'); // ‚Üê Usuario autenticado
      } else {
        router.replace('/login');      // ‚Üê Usuario NO autenticado
      }
    }
  }, [user, loading]);

  return <ActivityIndicator />; // ‚Üê Mientras verifica
}
```

**¬øQu√© hace?**
- Espera a que termine `initialize()` (`loading = false`)
- Si hay `user` ‚Üí va a `/dashboard`
- Si NO hay `user` ‚Üí va a `/login`

---

### 4Ô∏è‚É£ Pantalla de Login

**Archivo**: `src/features/auth/LoginScreen.jsx`

```jsx
const handleLogin = async () => {
  if (!validateForm()) return;

  const result = await signIn(email, password);

  if (result.success) {
    router.replace('/dashboard'); // ‚Üê Redirige al dashboard
  } else {
    Alert.alert('Error', result.error);
  }
};
```

**Flujo:**
1. Usuario ingresa email y password
2. Presiona "Iniciar Sesi√≥n"
3. `handleLogin()` valida el formulario
4. Llama a `signIn()` del authStore
5. Si es exitoso ‚Üí actualiza `user` en el store
6. Redirige a `/dashboard`

**AuthStore - signIn():**
```jsx
signIn: async (email, password) => {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) return { success: false, error: error.message };

  set({
    user: data.user,      // ‚Üê Actualiza el estado
    session: data.session,
    loading: false,
  });

  return { success: true };
}
```

---

### 5Ô∏è‚É£ Pantalla de Dashboard

**Archivo**: `src/features/dashboard/DashboardScreen.jsx`

```jsx
const handleLogout = () => {
  Alert.alert(
    'Cerrar Sesi√≥n',
    '¬øEst√°s seguro?',
    [
      { text: 'Cancelar' },
      {
        text: 'Cerrar Sesi√≥n',
        onPress: async () => {
          await signOut();
          router.replace('/login'); // ‚Üê ‚úÖ ARREGLADO!
        },
      },
    ]
  );
};
```

**Flujo:**
1. Usuario presiona "Salir"
2. Aparece confirmaci√≥n (Alert)
3. Si confirma ‚Üí llama `signOut()`
4. Limpia la sesi√≥n en Supabase
5. Limpia `user` en el store
6. **Redirige a `/login`** ‚Üê Este era el problema!

**AuthStore - signOut():**
```jsx
signOut: async () => {
  await supabase.auth.signOut();

  set({
    user: null,      // ‚Üê Limpia el usuario
    session: null,
    loading: false,
  });

  return { success: true };
}
```

---

## üêõ Problema que se arregl√≥

### ‚ùå Antes (NO FUNCIONABA)

```jsx
// DashboardScreen.jsx
const handleLogout = () => {
  Alert.alert('Cerrar Sesi√≥n', '...', [
    {
      text: 'Cerrar Sesi√≥n',
      onPress: async () => {
        await signOut();
        // ‚ùå NO REDIRIG√çA! Se quedaba en dashboard
      },
    },
  ]);
};
```

**Problema:**
- `signOut()` limpiaba el `user` del store
- Pero NO redirig√≠a a `/login`
- El usuario ve√≠a el dashboard vac√≠o o con error

### ‚úÖ Ahora (FUNCIONA)

```jsx
// DashboardScreen.jsx
const handleLogout = () => {
  Alert.alert('Cerrar Sesi√≥n', '...', [
    {
      text: 'Cerrar Sesi√≥n',
      onPress: async () => {
        await signOut();
        router.replace('/login'); // ‚Üê ‚úÖ Redirige expl√≠citamente!
      },
    },
  ]);
};
```

**Soluci√≥n:**
- Agregamos `router.replace('/login')` despu√©s de `signOut()`
- Ahora redirige inmediatamente a login

---

## üîê Persistencia de Sesi√≥n

### C√≥mo funciona

**Supabase + AsyncStorage:**

1. **Primer login:**
   ```
   signIn() ‚Üí Supabase guarda token en AsyncStorage
   ```

2. **App se cierra y reabre:**
   ```
   initialize() ‚Üí Lee token de AsyncStorage
              ‚Üí Valida con Supabase
              ‚Üí Si es v√°lido, restaura sesi√≥n
              ‚Üí user = {...}
   ```

3. **Sign out:**
   ```
   signOut() ‚Üí Borra token de AsyncStorage
            ‚Üí user = null
   ```

### Archivo de configuraci√≥n

**src/services/supabase.js:**
```jsx
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    storage: AsyncStorage,      // ‚Üê Guarda tokens aqu√≠
    autoRefreshToken: true,      // ‚Üê Refresca autom√°ticamente
    persistSession: true,        // ‚Üê Persiste entre sesiones
    detectSessionInUrl: false,
  },
});
```

---

## üéØ Resumen del Flujo Completo

### Usuario Nuevo (Sin Sesi√≥n)
```
App inicia
  ‚Üí initialize() ‚Üí user = null
  ‚Üí index.jsx detecta user = null
  ‚Üí Redirige a /login
  ‚Üí Usuario ingresa credenciales
  ‚Üí signIn() exitoso ‚Üí user = {...}
  ‚Üí Redirige a /dashboard
  ‚Üí Usuario ve su dashboard ‚úÖ
```

### Usuario Regresa (Con Sesi√≥n)
```
App inicia
  ‚Üí initialize() ‚Üí Lee AsyncStorage
  ‚Üí Valida con Supabase
  ‚Üí user = {...} (sesi√≥n restaurada)
  ‚Üí index.jsx detecta user = {...}
  ‚Üí Redirige a /dashboard directamente
  ‚Üí Usuario ve su dashboard ‚úÖ
```

### Usuario hace Sign Out
```
Usuario en dashboard
  ‚Üí Presiona "Salir"
  ‚Üí Confirma en Alert
  ‚Üí signOut() ‚Üí user = null
  ‚Üí router.replace('/login')
  ‚Üí Usuario ve login ‚úÖ
```

---

## üìù Archivos Involucrados

| Archivo | Responsabilidad |
|---------|-----------------|
| `app/_layout.jsx` | Inicializa auth al iniciar |
| `app/index.jsx` | Redirige seg√∫n estado de auth |
| `app/login.jsx` | Ruta de login |
| `app/dashboard.jsx` | Ruta de dashboard |
| `src/store/authStore.js` | Estado global de auth |
| `src/services/supabase.js` | Cliente de Supabase |
| `src/features/auth/LoginScreen.jsx` | UI de login |
| `src/features/dashboard/DashboardScreen.jsx` | UI de dashboard |

---

## ‚úÖ Estado Actual

- ‚úÖ **Login**: Funciona
- ‚úÖ **Logout**: Funciona (arreglado!)
- ‚úÖ **Redirecci√≥n autom√°tica**: Funciona
- ‚úÖ **Persistencia de sesi√≥n**: Funciona
- ‚úÖ **Loading states**: Funciona
- ‚úÖ **Manejo de errores**: Funciona

---

## üöÄ Pr√≥ximos Pasos

Para mejorar el flujo (opcional):

1. **Agregar guards de ruta**
   - Proteger `/dashboard` para solo usuarios autenticados

2. **Agregar refresh token autom√°tico**
   - Ya est√° configurado en Supabase

3. **Agregar "Recordarme"**
   - Checkbox en login para sesiones largas

4. **Agregar recuperaci√≥n de contrase√±a**
   - Usar `resetPassword()` del authStore

---

**Todo funciona correctamente! üéâ**
